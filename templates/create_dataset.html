<!DOCTYPE html>
<html>
<head>
    <title>Crear Dataset de Símbolos</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
        var mousePressed = false;
        var lastX, lastY;
        var ctx;
        var currentSymbol = '{{ symbols[0] }}'; // Default to the first symbol
        var symbols_display = JSON.parse('{{ symbols_display | tojson | safe }}');

        function InitThis() {
            ctx = document.getElementById('myCanvas').getContext("2d");
            setSymbolToDraw(currentSymbol); // Initialize with the default symbol
            var canvas = $('#myCanvas'); // Cache jQuery object

            canvas.on('mousedown', function (e) {
                mousePressed = true;
                Draw(e.pageX - canvas.offset().left, e.pageY - canvas.offset().top, false);
                e.preventDefault(); // Prevent default mouse behavior
            });

            canvas.on('mousemove', function (e) {
                if (mousePressed) {
                    Draw(e.pageX - canvas.offset().left, e.pageY - canvas.offset().top, true);
                }
                e.preventDefault(); // Prevent default mouse behavior
            });

            canvas.on('mouseup', function (e) {
                mousePressed = false;
                e.preventDefault(); // Prevent default mouse behavior
            });

            canvas.on('mouseleave', function (e) {
                mousePressed = false;
                e.preventDefault(); // Prevent default mouse behavior
            });

            // Touch events
            canvas.on('touchstart', function (e) {
                mousePressed = true;
                var touch = e.originalEvent.touches[0] || e.originalEvent.changedTouches[0];
                Draw(touch.pageX - canvas.offset().left, touch.pageY - canvas.offset().top, false);
                e.preventDefault(); // Important to prevent scrolling on touch devices
            });

            canvas.on('touchmove', function (e) {
                if (mousePressed) {
                    var touch = e.originalEvent.touches[0] || e.originalEvent.changedTouches[0];
                    Draw(touch.pageX - canvas.offset().left, touch.pageY - canvas.offset().top, true);
                }
                e.preventDefault(); // Important to prevent scrolling on touch devices
            });

            canvas.on('touchend', function (e) {
                mousePressed = false;
                e.preventDefault(); // Important to prevent scrolling on touch devices
            });
            
            canvas.on('touchcancel', function (e) { // Handle cases like when the touch leaves the screen
                mousePressed = false;
                e.preventDefault();
            });
        }

        function Draw(x, y, isDown) {
            if (isDown) {
                ctx.beginPath();
                ctx.strokeStyle = 'black';
                ctx.lineWidth = 11; // Canvas line width
                ctx.lineJoin = "round";
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(x, y);
                ctx.closePath();
                ctx.stroke();
            }
            lastX = x; lastY = y;
        }

        function clearArea() {
            ctx.setTransform(1, 0, 0, 1, 0, 0);
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
        }

        function prepareImg() {
            var canvas = document.getElementById('myCanvas');
            document.getElementById('myImage').value = canvas.toDataURL();
            document.getElementById('symbol_hidden_input').value = currentSymbol;
        }

        function setSymbolToDraw(symbolKey) {
            currentSymbol = symbolKey;
            document.getElementById('mensaje').innerHTML = 'Dibujando un: ' + symbols_display[symbolKey];
            // Optionally highlight the active button
            var buttons = document.querySelectorAll('.symbol-btn');
            buttons.forEach(function(btn) {
                btn.classList.remove('active');
                if (btn.getAttribute('data-symbol') === symbolKey) {
                    btn.classList.add('active');
                }
            });
            clearArea();
        }

    </script>
</head>
<body onload="InitThis();">
    <header>
        <div class="header-content">
            <img src="https://upload.wikimedia.org/wikipedia/commons/f/f7/Uni-logo_transparente_granate.png" alt="Logo Uni" class="logo">
            <h1>Crear Dataset de Símbolos</h1>
            <p>Dibuja símbolos para entrenar el modelo de reconocimiento</p>
        </div>
    </header>

    <nav>
        <div class="nav-container">
            <a href="{{ url_for('index') }}">
                <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iIzgwMDAyMCIgZD0iTTEwLDIwVjE0SDR2Nkg5TTExLDIwaDRsMy42LTYuNWM0LC0xLjUgMS41LC0zIDEuNSwtM3Y0LjVINHYtNC41YzAsMCAtLjUsMS41IDMuMiwzTDExLDIwTTEyLDJBMywzIDAgMCwxIDE1LDVsLS4xLC42TDEzLjY0LDEwSDEwLjM2TDguOSw1LjZMOC43NCw1QTMsMyAwIDAsMSAxMiwyeiIvPjwvc3ZnPg==" alt="Inicio">
                Inicio
            </a>
            <a href="{{ url_for('create_dataset_page') }}" class="active-nav">
                <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iIzgwMDAyMCIgZD0iTTE5LDEzSDEzVjE5SDExVjEzSDVWMTFIMTFWNUgxM1YxMUgxOVYxM1oiLz48L3N2Zz4=" alt="Crear Dataset">
                Crear Dataset
            </a>
            <a href="{{ url_for('train_page') }}">
                <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iIzgwMDAyMCIgZD0iTTEzLDEzSDExVjdIMTNNMTMsMTdIMTFWMTVIMTNNMTIsMkExMCwxMCAwIDAsMCAyLDEyQTEwLDEwIDAgMCwwIDEyLDIyQTEwLDEwIDAgMCwwIDIyLDEyQTEwLDEwIDAgMCwwIDEyLDJaIi8+PC9zdmc+" alt="Entrenar Modelo">
                Entrenar Modelo
            </a>
            <a href="{{ url_for('predict_page') }}">
                <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iIzgwMDAyMCIgZD0iTTkuOSwxN0w5LDE3QzYuOSwxNyA2LDE2LjEgNiwxNEw2LDEwQzYsNy45IDYuOSw3IDksN0wxNSw3QzE3LjEsNyAxOCw3LjkgMTgsMTBMMTgsMTRDMTgsMTYuMSAxNy4xLDE3IDE1LDE3TDE0LjEsMTdMMTIsMjBMMTAuOCwxOEwxMiwxN0wxMiw1TDEyLDVMMTIsNUMxMiw1IDEyLDUgOSw1QzksNSA5LDUgOSw1TDgsNUw4LDhMMTIsOEwxMiwxMkw4LDEyTDgsMTVMOSwxNUwxMCwxN0w5LjksMTdMMTIsMjBMOS45LDE3WiIvPjwvc3ZnPg==" alt="Predecir Símbolo">
                Predecir Símbolo
            </a>
        </div>
    </nav>

    <main>
        <h2>Creación del Dataset de Símbolos</h2>
        
        <div class="controls">
            <p>Selecciona el símbolo a dibujar:</p>
            <div class="button-group">
                {% for sym_key in symbols %}
                <button class="symbol-btn" data-symbol="{{ sym_key }}" onclick="setSymbolToDraw('{{ sym_key }}')">
                    {{ symbols_display[sym_key] }}
                </button>
                {% endfor %}
            </div>
        </div>

        <div style="display: flex; flex-direction: column; align-items: center;">
            <h2 id="mensaje">Dibujando...</h2>
            
            <div class="canvas-container">
                <canvas id="myCanvas" width="300" height="300"></canvas>
            </div>
        </div>
        
        <div class="button-group">
            <button onclick="clearArea();return false;" class="action-btn">
                <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iIzgwMDAyMCIgZD0iTTE5LDRIMTVWM0g5VjRINVY2SDE5TTYsMTlBMiwyIDAgMCwwIDgsMjFIMTZBMiwyIDAgMCwwIDE4LDE5VjdINlYxOVoiLz48L3N2Zz4=" alt="Borrar">
                Borrar
            </button>
        </div>
        
        <form method="post" action="{{ url_for('upload_image') }}" onsubmit="prepareImg();" enctype="multipart/form-data">
            <input id="symbol_hidden_input" name="symbol" type="hidden" value="">
            <input id="myImage" name="myImage" type="hidden" value="">
            <button type="submit" class="action-btn primary-btn">
                <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iI2ZmZmZmZiIgZD0iTTE3LDNBMiwyIDAgMCwxIDE5LDVWMjFBMiwyIDAgMCwxIDE3LDIzSDdDNS44OSwyMyA1LDIyLjEgNSwyMVY1QzUsMy44OSA1Ljg5LDMgNywzSDE3TTEyLDE0TDE1LjUsMTAuNUwxNi4zMSwxMS4zTDEyLjU4LDE1LjAzTDEyLDE1LjZMOC4zMSwxMkw5LjExLDExLjJMMTIsMTRaIi8+PC9zdmc+" alt="Guardar">
                Guardar Imagen
            </button>
        </form>
    </main>

    <footer>
        <p>&copy; 2025 Proyecto de Reconocimiento de Símbolos | Universidad Nacional de Ingeniería</p>
    </footer>
</body>
</html>
